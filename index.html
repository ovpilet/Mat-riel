const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE'; // *** IMPORTANT: REMPLACEZ PAR L'ID DE VOTRE FEUILLE DE CALCUL ***
const RESERVATIONS_SHEET_NAME = 'Reservations';
const NAMES_SHEET_NAME = 'Noms';
const ARTICLES_SHEET_NAME = 'Articles';

/**
 * Publie la page web.
 * Pour que la page HTML puisse appeler google.script.run,
 * le script doit être déployé en tant qu'application Web.
 * Dans l'éditeur Apps Script, allez dans Déploiement > Nouveau déploiement.
 * Choisissez "Application Web" comme type, donnez l'accès "Tout le monde".
 * Copiez l'URL pour la référence si nécessaire, mais google.script.run n'en a pas besoin.
 */
function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index'); // Assurez-vous que votre fichier HTML est nommé Index.html
}

/**
 * Récupère toutes les données (réservations, noms, catégories/articles) pour le chargement initial.
 * @returns {Object} Un objet contenant toutes les données.
 */
function loadAllData() {
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);

    // Charger les réservations
    const reservationsSheet = spreadsheet.getSheetByName(RESERVATIONS_SHEET_NAME);
    let reservations = [];
    if (reservationsSheet) {
      const dataRange = reservationsSheet.getDataRange();
      const values = dataRange.getDisplayValues();
      if (values.length > 1) { // Skip header row
        for (let i = 1; i < values.length; i++) {
          const row = values[i];
          // Assurez-vous que l'ordre des colonnes correspond à votre structure
          // Colonnes attendues: Noms (JSON), Date Départ, Date Retour, Articles (JSON)
          try {
            const names = row[0] ? JSON.parse(row[0]) : [];
            const articles = row[3] ? JSON.parse(row[3]) : [];
            reservations.push({
              names: names,
              startDate: row[1],
              endDate: row[2],
              articles: articles
            });
          } catch (e) {
            console.error(`Erreur de parsing JSON pour la ligne ${i + 1} de Réservations: ${e.message}`);
            // Gérer les lignes mal formées si nécessaire
          }
        }
      }
    } else {
      // Créer la feuille si elle n'existe pas
      spreadsheet.insertSheet(RESERVATIONS_SHEET_NAME);
      spreadsheet.getSheetByName(RESERVATIONS_SHEET_NAME).appendRow(['Noms (JSON)', 'Date Départ', 'Date Retour', 'Articles (JSON)']);
    }

    // Charger les noms existants
    const namesSheet = spreadsheet.getSheetByName(NAMES_SHEET_NAME);
    let existingNames = [];
    if (namesSheet) {
      const nameValues = namesSheet.getDataRange().getDisplayValues();
      if (nameValues.length > 0) {
        existingNames = nameValues.flat().filter(name => name !== ''); // Supprime les cellules vides
      }
    } else {
      spreadsheet.insertSheet(NAMES_SHEET_NAME);
      spreadsheet.getSheetByName(NAMES_SHEET_NAME).appendRow(['Noms']);
    }

    // Charger les catégories et articles
    const articlesSheet = spreadsheet.getSheetByName(ARTICLES_SHEET_NAME);
    let categoriesAndItems = {};
    if (articlesSheet) {
      const articleValues = articlesSheet.getDataRange().getDisplayValues();
      if (articleValues.length > 1) { // Skip header row
        for (let i = 1; i < articleValues.length; i++) {
          const category = articleValues[i][0];
          const item = articleValues[i][1];
          if (category && item) {
            if (!categoriesAndItems[category]) {
              categoriesAndItems[category] = [];
            }
            categoriesAndItems[category].push(item);
          }
        }
      }
    } else {
      spreadsheet.insertSheet(ARTICLES_SHEET_NAME);
      spreadsheet.getSheetByName(ARTICLES_SHEET_NAME).appendRow(['Catégorie', 'Article']);
    }

    return {
      status: 200,
      reservations: reservations,
      existingNames: existingNames,
      categoriesAndItems: categoriesAndItems
    };

  } catch (e) {
    console.error("Erreur lors du chargement des données: ", e);
    return { status: 500, message: `Échec du chargement des données: ${e.message}` };
  }
}

/**
 * Sauvegarde les réservations (l'ensemble du tableau).
 * @param {Array<Object>} reservationsData - Tableau d'objets réservation.
 * Chaque objet doit contenir names (Array<String>), startDate (String), endDate (String), articles (Array<Object>).
 * Chaque objet article doit contenir category (String) et name (String).
 */
function saveReservations(reservationsData) {
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = spreadsheet.getSheetByName(RESERVATIONS_SHEET_NAME);
    if (!sheet) {
      return { status: 404, message: `La feuille '${RESERVATIONS_SHEET_NAME}' est introuvable.` };
    }

    // Effacer toutes les données existantes sauf l'en-tête
    sheet.getRange(2, 1, sheet.getLastRow(), sheet.getLastColumn()).clearContent();

    const dataToSave = [];
    reservationsData.forEach(reservation => {
      const namesString = JSON.stringify(reservation.names);
      const articlesString = JSON.stringify(reservation.articles);
      dataToSave.push([namesString, reservation.startDate, reservation.endDate, articlesString]);
    });

    if (dataToSave.length > 0) {
      sheet.getRange(2, 1, dataToSave.length, dataToSave[0].length).setValues(dataToSave);
    }
    spreadsheet.toast('Réservations sauvegardées !', 'Succès', 3);
    return { status: 200, message: 'Réservations sauvegardées avec succès.' };
  } catch (e) {
    console.error("Erreur lors de la sauvegarde des réservations: ", e);
    return { status: 500, message: `Échec de la sauvegarde des réservations: ${e.message}` };
  }
}

/**
 * Sauvegarde la liste des noms existants.
 * @param {Array<string>} names - La liste des noms.
 */
function saveNames(names) {
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = spreadsheet.getSheetByName(NAMES_SHEET_NAME);
    if (!sheet) {
      return { status: 404, message: `La feuille '${NAMES_SHEET_NAME}' est introuvable.` };
    }

    // Effacer toutes les données existantes
    sheet.clearContents();
    sheet.appendRow(['Noms']); // Remettre l'en-tête

    if (names && names.length > 0) {
      const dataToSave = names.map(name => [name]);
      sheet.getRange(2, 1, dataToSave.length, dataToSave[0].length).setValues(dataToSave);
    }
    return { status: 200, message: 'Noms sauvegardés avec succès.' };
  } catch (e) {
    console.error("Erreur lors de la sauvegarde des noms: ", e);
    return { status: 500, message: `Échec de la sauvegarde des noms: ${e.message}` };
  }
}

/**
 * Sauvegarde les catégories et les articles.
 * @param {Object} categoriesAndItems - Un objet où les clés sont des catégories et les valeurs sont des tableaux d'articles.
 */
function saveCategoriesAndItems(categoriesAndItems) {
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = spreadsheet.getSheetByName(ARTICLES_SHEET_NAME);
    if (!sheet) {
      return { status: 404, message: `La feuille '${ARTICLES_SHEET_NAME}' est introuvable.` };
    }

    // Effacer toutes les données existantes
    sheet.clearContents();
    sheet.appendRow(['Catégorie', 'Article']); // Remettre l'en-tête

    const dataToSave = [];
    for (const category in categoriesAndItems) {
      if (categoriesAndItems.hasOwnProperty(category)) {
        categoriesAndItems[category].forEach(item => {
          dataToSave.push([category, item]);
        });
      }
    }

    if (dataToSave.length > 0) {
      sheet.getRange(2, 1, dataToSave.length, dataToSave[0].length).setValues(dataToSave);
    }
    return { status: 200, message: 'Catégories et articles sauvegardés avec succès.' };
  } catch (e) {
    console.error("Erreur lors de la sauvegarde des catégories et articles: ", e);
    return { status: 500, message: `Échec de la sauvegarde des catégories et articles: ${e.message}` };
  }
}
